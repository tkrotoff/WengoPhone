# Bugfix, spaces don't work with install target
string(REPLACE "CMAKEBUGWITHSPACES" " " BUILD_DIR ${BUILD_DIR})
string(REPLACE "CMAKEBUGWITHSPACES" " " SOURCE_DIR ${SOURCE_DIR})


find_file(NSIS_PROGRAM
	NAMES
		makensis.exe
	PATHS
		"C:/Program Files/NSIS/"
)

if (NSIS_PROGRAM)
	message(STATUS "Found NSIS: ${NSIS_PROGRAM}")
else (NSIS_PROGRAM)
	message(FATAL_ERROR "Could not find NSIS")
endif (NSIS_PROGRAM)


set(INSTALLER_NAME
	WengoPhone-${APPLICATION_VERSION}-setup
)

set(NSIS_ARGS
	/DPRODUCT_NAME=${APPLICATION_NAME}
	/DPRODUCT_VERSION=${APPLICATION_VERSION}
	/DBUILD_DIR=${BUILD_DIR}
	/DQTDIR=$ENV{QTDIR}
)

if (BUILD_TYPE MATCHES Debug)
	set(NSIS_ARGS
		${NSIS_ARGS}
		/DDEBUG
	)
endif (BUILD_TYPE MATCHES Debug)

string(TOLOWER ${BUILD_TYPE} BUILD_TYPE)
set(INSTALLER_NAME ${INSTALLER_NAME}-${BUILD_TYPE})

if (INSTALLER_WITH_PDB)
	set(NSIS_ARGS
		${NSIS_ARGS}
		/DWITH_PDB
	)
endif (INSTALLER_WITH_PDB)

if (NOT SVN_REVISION OR SVN_REVISION EQUAL 0)
	set(INSTALLER_NAME ${INSTALLER_NAME}-norev.exe)
else (NOT SVN_REVISION OR SVN_REVISION EQUAL 0)
	set(INSTALLER_NAME ${INSTALLER_NAME}-rev${SVN_REVISION}.exe)
endif (NOT SVN_REVISION OR SVN_REVISION EQUAL 0)

set(NSIS_ARGS
	${NSIS_ARGS}
	/DINSTALLER_NAME=${INSTALLER_NAME}
)

execute_process(
	COMMAND ${NSIS_PROGRAM} ${NSIS_ARGS} ${SOURCE_DIR}/wengophone/nsis/installer.nsi
	WORKING_DIRECTORY ${BUILD_DIR}
)
